---
layout: post
title: "Claude Code の使用量をtmuxのステータスバーでリアルタイム監視する「claude-tmux-status」を作った"
img_path: /assets/img/logos
image:
  path: logo-only.svg
  width: 100%
  height: 100%
  alt: Zenn
category: [Tech]
tags: ["claudecode", "claude", "tmux", "python", "個人開発"]
date: "2026-02-23 13:00"
---


---

この記事は[Zenn](https://zenn.dev/long910/articles/2026-02-23-claude-tmux-status)でも公開しています。


Claude Code を使っていると「気づいたら使用量が上限に達していた」という経験、ありませんか？

作業に集中しているとつい忘れてしまう使用量の確認。かといって別のウィンドウを開いて確認するのも手間です。

そこで、**tmuxのステータスバーに常時表示**する「claude-tmux-status」を作りました。

https://github.com/long-910/claude-tmux-status

---

## こんな画面になります

tmuxを使っていると、ターミナルの下部にこんな表示が常に出ます：

```
🤖 5h:78%(2h47m) 7d:84%!
```

これだけで「5時間ウィンドウの消費率78%、リセットまで2時間47分、週間使用率84%で警告状態」がひと目でわかります。

コスト表示モードに切り替えると：

```
🤖 5h:$9.42 day:$9.42 7d:$48.39
```

今日と今週でいくら使ったかもリアルタイムで確認できます。

---

## なぜ作ったか

Claude Code の使用量制限は「5時間のローリングウィンドウ」と「週間制限」の2つで管理されています（詳細は[こちらの記事](https://zenn.dev/long910/articles/2026-02-21-claude-code-usage-limit)を参照）。

問題は、この使用量が**どこにも常時表示されない**ことです。

- 上限に達してから初めて「あ、使いすぎた」と気づく
- 別のブラウザタブやコマンドを都度開いて確認するのが面倒
- 作業フローが途切れる

tmuxユーザーであれば、ステータスバーには常にCPU使用率・時刻・バッテリー残量などを表示しているはずです。**Claude Code の使用量もそこに並べてしまおう**というのが発想の出発点です。

---

## 機能

### 表示モード1: パーセントモード（デフォルト）

```
🤖 5h:78%(2h47m) 7d:84%!
```

| 部分      | 意味                                    |
| --------- | --------------------------------------- |
| `5h:78%`  | 5時間ウィンドウの消費率                 |
| `(2h47m)` | 5時間ウィンドウのリセットまでの残り時間 |
| `7d:84%!` | 週間消費率（`!`は75%超の警告）          |

Claude が非アクティブのときはキャッシュの経過時間も表示され、データの鮮度がわかります。

### 表示モード2: コストモード

```
🤖 5h:$9.42 day:$9.42 7d:$48.39
```

| 部分        | 意味                          |
| ----------- | ----------------------------- |
| `5h:$9.42`  | 現在の5時間ウィンドウのコスト |
| `day:$9.42` | 当日のトータルコスト          |
| `7d:$48.39` | 週間トータルコスト            |

コストはローカルの JSONL ファイルから集計するため、**このモードではAPIを呼び出しません**。

### 表示モード3: 詳細モード（ロング表示）

`claude-usage long` で、プログレスバーと全メトリクスが1画面に表示されます：

```
=== Claude Code Usage ===
5h window:  [████████░░] 78% (!WARNING) | Reset in: 2h47m
7d window:  [████████░░] 84% (!WARNING)

--- Cost Summary ---
5h cost:    $9.42
Day cost:   $9.42
7d cost:    $48.39
```

### ステータスインジケーター

| マーク   | 状態            |
| -------- | --------------- |
| （なし） | 正常（75%未満） |
| `!`      | 警告（75%以上） |
| `✗`      | 上限到達        |

---

## 必要環境

- Python 3.10 以上
- tmux 3.0 以上
- Claude Code インストール済み（`~/.claude/.credentials.json` が存在すること）

---

## インストール

### 方法1: TPM（Tmux Plugin Manager）— 推奨

TPMを使っている場合は `~/.tmux.conf` に1行追加するだけです：

```tmux
set -g @plugin 'long-910/claude-tmux-status'
```

その後、tmux内で `Prefix + I` を押してインストール。

### 方法2: 手動インストール

```bash
git clone https://github.com/long-910/claude-tmux-status.git
cd claude-tmux-status
bash install.sh
```

`install.sh` は以下を自動で行います：

1. スクリプトを `~/.local/bin/claude-usage` にコピーして実行権限を付与
2. `~/.tmux.conf` にステータスバー表示の設定を追記
3. `Prefix + U` で表示モードを切り替えるキーバインドを設定

インストール後は新しいtmuxセッションを開くか、設定を再読み込みします：

```bash
tmux source-file ~/.tmux.conf
```

---

## 使い方

### コマンド一覧

| コマンド              | 説明                                    |
| --------------------- | --------------------------------------- |
| `claude-usage`        | tmux ステータスバー用のコンパクト表示   |
| `claude-usage toggle` | パーセントモード↔コストモードを切り替え |
| `claude-usage long`   | プログレスバー付きの詳細表示            |
| `claude-usage json`   | JSON形式で全データ出力                  |

### キーバインド

tmux内で `Prefix + U` を押すと、パーセントモードとコストモードがトグルで切り替わります。

### 表示モードの永続化

選択した表示モードは `~/.claude/tmux-display-mode` に保存されるため、tmuxセッションをまたいでも設定が引き継がれます。

---

## 設定オプション

`~/.tmux.conf` に以下を追記することでカスタマイズできます：

```tmux
# トグルキーの変更（デフォルト: U）
set -g @claude-tmux-toggle-key 'C'

# キャッシュの有効期間（秒）の変更（デフォルト: 300）
set -g @claude-tmux-cache-ttl '600'
```

---

## 仕組みと注意点

### スマートキャッシュ ── デフォルトはAPI呼び出しなし

このツールの最大の特徴は、**Claude が非アクティブなときは一切APIを呼び出さない**設計です。

具体的には `~/.claude/projects/**/*.jsonl`（Claude Code がローカルに記録する使用ログ）の更新タイムスタンプを監視しています。

- **Claude を使っていない（アイドル時）**: JSONL ファイルが更新されていないためキャッシュを使い回す → **API呼び出しなし**
- **Claude を使った直後**: JSONL が更新されたことを検知 → キャッシュが5分以上古ければAPIを呼び出して最新の使用率を取得

このアプローチにより「使用量を監視するためのツール自体が無駄に使用量を消費する」という問題を回避しています。

### API 呼び出しが発生するケース

レート制限の使用率（パーセント表示）は Anthropic API のレスポンスヘッダーから取得します。そのため、次の条件が揃ったときにのみ API を呼び出します：

1. キャッシュが5分以上古い（`@claude-tmux-cache-ttl` で変更可能）
2. かつ、直近で Claude Code が実際に動作した（JSONLが更新されている）

:::message
**リアルタイムポーリングはオプション**

常に最新の使用率を見たい場合は、定期的なポーリングを有効化できます。このモードでは Claude のアクティビティに関わらず5分ごとにAPIを呼び出します。

使用するモデルを `claude-haiku-4-5` に設定した場合の目安コストは **約 $0.001/日**（月換算で約 $0.03）です。
:::

:::message alert
**API 呼び出し時の使用量消費について**

APIリクエストが発生する際は `max_tokens: 1` の最小限のリクエストを送信しますが、**このリクエスト自体が使用量としてカウントされます**。

- 消費量は極めて微量です
- ただし、すでに使用量が上限ギリギリの状態では、このツールのAPI呼び出しが上限到達を早める可能性があります
- 認証には `~/.claude/.credentials.json` に保存された OAuth トークンを使用します
:::

### Claude Code の Stop フックによる自動更新

Claude Code のセッション終了時に自動でステータスを更新する Stop フック機能が組み込まれています。作業が終わった瞬間に表示が最新状態に切り替わるため、次の作業を始める前に使用量を確認できます。

### コストの計算

コストモード（`5h:$9.42 day:$9.42 7d:$48.39`）は、ローカルの JSONL から集計するため API を呼び出しません。

計算には Claude Sonnet 4.x の料金体系を使用します：

| トークン種別       | 料金（1Mトークンあたり） |
| ------------------ | ------------------------ |
| 入力トークン       | $3.00                    |
| 出力トークン       | $15.00                   |
| キャッシュ読み取り | $0.30                    |
| キャッシュ書き込み | $3.75                    |

---

## ccusage との違い

Claude Code の使用量を可視化するツールとして [ccusage](https://github.com/ryoppippi/ccusage) もあります。

| 機能                       | claude-tmux-status               | ccusage                      |
| -------------------------- | -------------------------------- | ---------------------------- |
| 表示場所                   | tmuxステータスバー（常時）       | ターミナル（要コマンド実行） |
| アイドル時のAPI呼び出し    | なし（スマートキャッシュ）       | ─                            |
| APIレート制限の表示         | ✅                               | ❌                           |
| 詳細な日別・月別集計        | ❌                               | ✅                           |
| インストール不要            | ❌                               | ✅（npx で即実行）           |
| TPM対応                    | ✅                               | ❌                           |

両者は用途が異なります。**常時監視したい**なら claude-tmux-status、**詳しく使用量を分析したい**なら ccusage、という使い分けが自然です。組み合わせて使うのが最強です。

---

## こんな方におすすめ

- **tmuxをメインで使っている開発者**：常時確認できるので使いすぎ防止に
- **Claude Code をヘビーに使っている方**：上限到達による作業中断を減らせます
- **コストを意識したい方**：コストモードで日々の出費をリアルタイムで把握
- **TPMで tmux プラグインを管理している方**：1行追加するだけで導入完了

逆に、tmuxを使っていない場合はこのツールの恩恵を受けられません。その場合は ccusage が便利です。

---

## まとめ

Claude Code の使用量をtmuxのステータスバーに常時表示する **claude-tmux-status** を紹介しました。

- TPM 対応で `~/.tmux.conf` に1行追加するだけで導入できる
- Claude が非アクティブなときは API を呼び出さないスマートキャッシュ設計
- パーセントモードとコストモードをキーバインドで切り替え可能
- Claude Code の Stop フックで作業終了と同時に自動更新

Claude Code を日常的に使っているtmuxユーザーの方は、ぜひ試してみてください。

スターをもらえると励みになります⭐

https://github.com/long-910/claude-tmux-status

---

## 参考リンク

- [Claude Code の使用量上限とうまく付き合う方法](https://zenn.dev/long910/articles/2026-02-21-claude-code-usage-limit) — 使用量制限の仕組みを詳しく解説
- [ccusage - GitHub](https://github.com/ryoppippi/ccusage) — 詳細な使用量分析ツール
- [tmux 公式ドキュメント](https://github.com/tmux/tmux/wiki) — status-right の設定方法など
